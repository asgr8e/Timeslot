import os
import base64
import json
import requests
import msal

# Set up MSAL client
client_id = "<your_client_id>"
client_secret = "<your_client_secret>"
tenant_id = "<your_tenant_id>"
authority = f"https://login.microsoftonline.com/{tenant_id}"
scope = ["https://graph.microsoft.com/.default"]
app = msal.ConfidentialClientApplication(
    client_id=client_id,
    client_credential=client_secret,
    authority=authority
)
result = app.acquire_token_silent(scope, account=None)
if not result:
    result = app.acquire_token_for_client(scopes=scope)

# Set up Graph API request
shared_mailbox_email = "<your_shared_mailbox_email>"
url = f"https://graph.microsoft.com/v1.0/users/{shared_mailbox_email}/messages?$filter=startswith(subject,'<your_subject>')&$select=subject,hasAttachments,attachments"
headers = {
    "Authorization": f"Bearer {result['access_token']}",
    "Content-Type": "application/json"
}

# Send Graph API request
response = requests.get(url, headers=headers)
response_json = response.json()

# Download attachments
for message in response_json["value"]:
    if message["hasAttachments"]:
        for attachment in message["attachments"]:
            if attachment["@odata.type"] == "#microsoft.graph.fileAttachment":
                attachment_id = attachment["id"]
                attachment_name = attachment["name"]
                attachment_url = f"https://graph.microsoft.com/v1.0/users/{shared_mailbox_email}/messages/{message['id']}/attachments/{attachment_id}/$value"
                attachment_response = requests.get(attachment_url, headers=headers)
                with open(attachment_name, "wb") as f:
                    f.write(base64.b64decode(attachment_response.content))
